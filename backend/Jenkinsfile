pipeline {
  agent any

  stages {

    stage('Checkout') {
      steps {
        git branch: 'main', url: 'https://github.com/Baribrahim/OneSky.git'
      }
    }

    stage('Install') {
      steps {
        // go straight into the real backend code
        dir('backend/functionality') {
          sh '''
            python3 -m venv venv
            . venv/bin/activate
            pip install --upgrade pip
            pip install -r requirements.txt
          '''
        }
      }
    }

    stage('Test') {
      steps {
        dir('backend/functionality') {
          // secret file in Jenkins with your .env content
          withCredentials([file(credentialsId: 'team1-backend-env', variable: 'ENV_FILE')]) {
            sh '''
              # do not echo commands with secrets
              set +x

              # copy the secret .env into workspace
              cp "$ENV_FILE" .env

              # pull ONLY the value we need right now
              OPENAI_API_KEY=$(grep -E '^OPENAI_API_KEY=' .env | head -n1 | cut -d= -f2- | tr -d '\\r')
              if [ -z "$OPENAI_API_KEY" ]; then
                echo "OPENAI_API_KEY not found in secret file"
                rm -f .env
                exit 1
              fi
              export OPENAI_API_KEY

              # activate venv and run tests
              . venv/bin/activate
              pytest --maxfail=1 --disable-warnings -q

              # cleanup
              rm -f .env
            '''
          }
        }
      }
    }

    stage('SonarQube Analysis') {
      environment {
        scannerHome = tool 'sonarqube'
      }
      steps {
        withSonarQubeEnv('sonar-qube-1') {
          // sonar-project.properties is in backend/, so run from there
          dir('backend') {
            sh "${scannerHome}/bin/sonar-scanner"
          }
        }

        timeout(time: 10, unit: 'MINUTES') {
          waitForQualityGate abortPipeline: true
        }
      }
    }

  }
}
