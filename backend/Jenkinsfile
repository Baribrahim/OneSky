pipeline {
  agent any

  stages {

    stage('Checkout') {
      steps {
        git branch: 'main', url: 'https://github.com/Baribrahim/OneSky.git'
      }
    }

    stage('Install') {
      steps {
        dir('backend/functionality') {
          sh '''
            python3 -m venv venv
            . venv/bin/activate
            pip install --upgrade pip
            pip install -r requirements.txt
          '''
        }
      }
    }

    stage('Test') {
      steps {
        dir('backend/functionality') {
          withCredentials([file(credentialsId: 'team1-backend-env', variable: 'ENV_FILE')]) {
            sh '''
              set +x
              # Load vars from credential file into current shell
              set -a
              . "$ENV_FILE"
              set +a

              . venv/bin/activate

              # Pass only what pytest needs
              OPENAI_API_KEY="$OPENAI_API_KEY" pytest --cov=. --cov-report=xml --cov-report=term --maxfail=1 --disable-warnings -q
            '''
          }
        }
      }
    }


    stage('SonarQube Analysis') {
      environment {
        scannerHome = tool 'sonarqube'
      }
      steps {
        withSonarQubeEnv('sonar-qube-1') {
          dir('backend') {
            sh "${scannerHome}/bin/sonar-scanner"
          }
        }

        timeout(time: 10, unit: 'MINUTES') {
          waitForQualityGate abortPipeline: true
        }
      }
    }

    stage('Inject .env files') {
      steps {
        withCredentials([
          file(credentialsId: 'team1-backend-env', variable: 'ENV_FILE'),
          file(credentialsId: 'team1-frontend-env', variable: 'FRONTEND_ENV')
        ]) {
          sh '''
            set +x
            # Copy backend env file to repo root for docker-compose (similar pattern to Test stage)
            cp "$ENV_FILE" ./backend/functionality/.env
            chmod 600 ./backend/functionality/.env
            
            # Copy frontend env file
            cp "$FRONTEND_ENV" ./frontend/.env
            chmod 600 ./frontend/.env
          '''
        }
      }
    }

    stage('Build & Start Docker Containers') {
      steps {
        sh 'docker compose up --build -d'
      }
    }

    stage('Generate Event Embeddings') {
      steps {
        sh '''
          echo "Waiting for containers to be ready..."
          sleep 10
          
          echo "Generating embeddings for all events..."
          docker compose exec -T backend python3 -m chatbot.generate_event_embeddings || {
            echo "Warning: Embedding generation failed or no events found. Continuing deployment..."
            exit 0
          }
        '''
      }
    }
  }
}